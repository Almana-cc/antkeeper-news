# Ralph Progress Log

This file tracks learnings and progress across iterations.
Each iteration appends new entries - NEVER delete or replace existing content.

---

## Iteration 1 - 2026-01-09T10:30:00Z
### Completed: US-001 - Create GitHub Actions workflow for weekly newsletter
### Implementation:
- Created `.github/workflows/newsletter.yml`
- Scheduled for Friday 9 AM UTC (`cron: '0 9 * * 5'`)
- Added `workflow_dispatch` for manual triggering
- Setup: checkout@v4, node@v4 (Node.js 20), pnpm/action-setup@v3
- Runs `node scripts/generate-newsletter.js` (requires US-002)
- Uses peter-evans/create-pull-request@v6 to create PRs
- PR title format: "Newsletter for week of [START_DATE] to [END_DATE]"
- Environment secrets required: OPENROUTER_API_KEY, DATABASE_URL

### Learnings:
- Branch `ralph/newsletter-articles-tags` was already checked out elsewhere, used `ralph/newsletter-articles-tags-amp` instead
- Pre-existing typecheck errors in codebase (ArticleWithDuplicates type issues, hub:db:schema module) - not related to this story
- No `pnpm lint` script exists, use `pnpm eslint` instead
- Date calculation in shell: use `date -d "7 days ago"` (Linux) or `date -v-7d` (macOS) with fallback

### Next Priority: US-002

---

## Iteration 2 - 2026-01-09T11:15:00Z
### Completed: US-002 - Create standalone newsletter generation script
### Implementation:
- Created `scripts/generate-newsletter.js` (339 lines)
- Uses OpenRouter API with `mistralai/mistral-7b-instruct:free` model
- `fetchArticles()`: Calls GET /api/articles?dateRange=week&limit=50
- `selectTopArticles()`: AI selects top 3 based on scientific importance, originality, quality
- `generateNewsletterContent()`: AI generates French content with intro, summaries, key points
- `writeNewsletter()`: Writes to `newsletters/YYYY-MM-DD.md`
- Fallback strategies: Empty newsletter if no articles, uses first 3 if AI selection fails, generates basic content if AI generation fails
- Rate limit handling with exponential backoff (3 retries, 5s base delay)
- CI/CD compatible: No user interaction required, exits with code 1 on failure

### Learnings:
- Existing `openrouter-categorization.service.ts` provides good patterns for OpenRouter API calls
- Script uses CommonJS (`require`) since it runs standalone with Node.js
- Pre-existing typecheck errors are unrelated to this work (confirmed in progress.txt iteration 1)
- Verified script syntax with `node --check scripts/generate-newsletter.js`

### Next Priority: US-003

---

## Iteration 3 - 2026-01-09T12:00:00Z
### Completed: US-003 - Add newsletter history and continuity checking
### Implementation:
- Added `getPreviousNewsletterContext()` function:
  - Reads up to 4 previous newsletters from `./newsletters/*.md`
  - Extracts article titles using regex (`## \d+\.\s+(.+)`)
  - Returns `{ recentStories: [], newsletterDates: [], rawContent: [] }`
- Added `formatPreviousStoriesForPrompt()` to format context for AI prompts
- Updated `selectTopArticles(articles, previousContext)`:
  - Added criterion 6: "ÉVITER les sujets déjà traités dans les newsletters précédentes"
  - Added instruction for follow-up selection if story evolved
  - Includes previous stories list in user prompt
- Updated `generateNewsletterContent(articles, previousContext)`:
  - Adds previous context section to prompt
  - Instructs AI to reference prior editions when covering follow-up stories
- Updated `main()` to fetch and pass previous context to both functions

### Learnings:
- Newsletter title format is consistent: `## {n}. {title}` - easy to parse with regex
- No typecheck script in package.json, use `pnpm nuxt typecheck`
- Pre-existing typecheck errors still present (ArticleWithDuplicates type) - unrelated to this work
- ESLint available via `pnpm eslint <file>`

### Next Priority: US-004

---

## Iteration 4 - 2026-01-09T13:00:00Z
### Completed: US-004 - Create /articles/[slug] dynamic route
### Implementation:
- Created `server/api/articles/[slug].get.ts`:
  - Fetches article by slug from database
  - Returns 404 if article not found
  - Returns article with all relevant fields
- Created `app/pages/articles/[slug].vue`:
  - Fetches article via useFetch()
  - Displays: category badge, title, meta info (source, author, date)
  - Shows featured image, summary, content, and tags
  - Back button to return to article list
  - Source link to read original article
  - Uses useSeoMeta for SEO (title, description)
  - Server-side rendered (SSR) by default in Nuxt
- Added i18n keys in all 4 languages (fr, en, es, de):
  - `articles.notFound`, `articles.backToList`, `articles.readOriginal`

### Learnings:
- Nuxt dynamic routes use `[param]` syntax (brackets)
- API routes in subdirectory need `mkdir -p` first
- `useSeoMeta()` is the Nuxt 3 way to set meta tags reactively
- Pre-existing typecheck errors still present - filter with grep to verify new files

### Next Priority: US-005

---

## Iteration 5 - 2026-01-09T14:00:00Z
### Completed: US-005 - Add Schema.org structured data to article pages
### Implementation:
- Updated `app/pages/articles/[slug].vue`:
  - Added JSON-LD structured data via `useHead()` with script type `application/ld+json`
  - Schema.org Article type with: headline, description, image, datePublished, dateModified
  - Author as Person (if author exists) or Organization (fallback to sourceName)
  - Publisher as Organization (Antkeeper News)
  - mainEntityOfPage and url fields
- Extended `useSeoMeta()` with OpenGraph tags:
  - og:type (article), og:title, og:description, og:image, og:url, og:site_name
  - article:published_time, article:author
- Added Twitter card meta tags:
  - twitter:card (summary_large_image), twitter:title, twitter:description, twitter:image
- Uses `useRuntimeConfig()` for site URL with fallback to 'https://antkeeper.news'

### Learnings:
- `useSeoMeta()` handles OpenGraph and Twitter meta tags natively in Nuxt 3
- JSON-LD must be added via `useHead({ script: [...] })` with `type: 'application/ld+json'`
- Pre-existing typecheck errors continue (ArticleWithDuplicates type) - not related to this work
- No errors introduced in `[slug].vue` file

### Next Priority: US-006


---

## Iteration 6 - 2026-01-09T15:00:00Z
### Completed: US-006 - Add related articles section by tags
### Implementation:
- Created `server/api/articles/[slug]/related.get.ts`:
  - Fetches article by slug, extracts tags
  - Queries for articles sharing at least one tag (PostgreSQL array overlap `&&`)
  - Excludes current article, limits to 5 results
  - Returns id, title, slug, imageUrl, publishedAt, sourceName
- Updated `app/pages/articles/[slug].vue`:
  - Added useFetch for related articles endpoint
  - Displays related articles in responsive grid (1/2/3 columns)
  - Cards show image, title, source, and date
  - Hover effects and smooth transitions
- Added i18n key `articles.relatedArticles` in all 4 languages:
  - FR: "Articles similaires"
  - EN: "Related articles"
  - ES: "Artículos relacionados"
  - DE: "Ähnliche Artikel"

### Learnings:
- PostgreSQL array overlap operator `&&` works well for tag matching
- Nested dynamic routes work in Nuxt: `[slug]/related.get.ts` creates `/api/articles/:slug/related`
- Pre-existing typecheck errors unrelated to this work (ArticleWithDuplicates, hub:db:schema)
- Used explicit type annotation `(tag: string)` to avoid implicit any error

### Next Priority: US-007

---

## Iteration 7 - 2026-01-09T16:00:00Z
### Completed: US-007 - Create tag translations database table
### Implementation:
- Updated `server/db/schema.ts`:
  - Added `tagTranslations` table with fields: id, tagKey, language, label
  - Added imports for `index` and `uniqueIndex` from drizzle-orm/pg-core
  - Created indexes: `tag_translations_tag_key_idx`, `tag_translations_language_idx`
  - Created unique composite index: `tag_translations_tag_key_language_unique`
- Created `server/db/migrations/postgresql/0004_tag_translations.sql`:
  - Creates table with all required columns and indexes
- Created `server/db/migrations/postgresql/0005_seed_tag_translations.sql`:
  - Seeds 20 common tags in FR/EN/ES/DE (80 total translations)
  - Topics: care, research, behavior, conservation, breeding, ecology
  - Content types: study, news, guide, tutorial, community, opinion
  - Geographic regions: north america, europe, amazon, mediterranean, asia, africa
  - Common species: lasius niger, camponotus, formica, leaf-cutter ants, fire ants
  - Uses `ON CONFLICT ... DO UPDATE` for idempotent seeding

### Learnings:
- Drizzle schema indexes are defined in a callback function as second argument to pgTable
- Pre-existing typecheck errors in codebase unrelated to this work (ArticleWithDuplicates, hub:db:schema)
- ESLint passes on schema.ts with no issues
- Migration files are plain SQL in this project (not Drizzle Kit generated)

### Next Priority: US-008

---

## Iteration 8 - 2026-01-09T17:00:00Z
### Completed: US-008 - Build tag translation service
### Implementation:
- Created `server/services/tag-translation.service.ts`:
  - `getTranslatedTags(tags: string[], locale: string)`: Fetches translations for specific tags
  - `getAllTranslationsForLocale(locale: string)`: Fetches all translations for a locale
  - `clearTranslationCache()`: Utility to clear cache after DB updates
  - In-memory cache with 5-minute TTL for performance
  - Falls back to tag key if translation missing
- Created `server/api/tags/translations.get.ts`:
  - GET /api/tags/translations?locale=fr returns all translations for locale
  - GET /api/tags/translations?locale=fr&tags[]=care&tags[]=research returns specific tags
  - Uses existing ../utils/db pattern for database access

### Learnings:
- Services should import from `../utils/db` not `hub:db` for consistency
- Simple in-memory Map cache works well for this use case (no external dependency)
- Pre-existing typecheck errors continue (ArticleWithDuplicates, hub:db:schema) - unrelated to this work
- Nested API routes (tags/translations.get.ts) create clean REST endpoints

### Next Priority: US-009

---

## Iteration 9 - 2026-01-09T18:00:00Z
### Completed: US-009 - Update UI to show translated tag labels
### Implementation:
- Created `app/composables/useTagTranslations.ts`:
  - Uses `useFetch` to load translations from `/api/tags/translations` with current locale
  - Auto-refreshes when locale changes via `watch: [locale]`
  - Provides `getTagLabel(tag)` for single tag translation
  - Provides `getTagLabels(tags)` for batch translation
  - Falls back to tag key if translation unavailable
- Updated `app/components/ArticleCard.vue`:
  - Added `useTagTranslations()` composable
  - Changed tag badge labels from `tag` to `getTagLabel(tag)`
- Updated `app/pages/index.vue`:
  - Added `useTagTranslations()` composable
  - Changed `availableTags` computed to return objects with `value` (canonical key) and `label` (translated)
  - Added `value-key="value"` to USelectMenu for proper v-model binding
- Updated `app/pages/articles/[slug].vue`:
  - Added `useTagTranslations()` composable
  - Changed tag badge labels to use `getTagLabel(tag)`

### Learnings:
- Nuxt auto-imports composables from `app/composables/` directory
- USelectMenu `value-key` prop allows using objects while keeping v-model as the value field
- Pre-existing typecheck and ESLint errors continue (ArticleWithDuplicates, hub:db:schema, unused vars) - unrelated to this work
- All pre-existing linting issues documented (getLanguageFlag unused, `any` in query object)

### Next Priority: ALL STORIES COMPLETE
