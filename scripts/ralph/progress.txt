# Ralph Progress Log

This file tracks learnings and progress across iterations.
Each iteration appends new entries - NEVER delete or replace existing content.

---

## Iteration 1 - 2026-01-11T00:00:00Z
### Completed: US-001 - Fix related articles showing duplicates
### Implementation:
- Modified `server/api/articles/[slug]/related.get.ts`
- Added query to `articleDuplicates` table to find all canonical/duplicate relationships
- Used `notInArray` filter to exclude all duplicate article IDs from results
- Removed unused `ne` import to fix lint error
### Learnings:
- The `articleDuplicates` table has bidirectional relationships: an article can be either `canonicalArticleId` or `duplicateArticleId`
- Need to check both fields with `or()` condition when finding duplicates
- This project doesn't have `pnpm typecheck` or `pnpm lint` scripts - use `npx vue-tsc --noEmit` and `npx eslint .` instead
- File paths with brackets need single quotes in bash: `'server/api/articles/[slug]/related.get.ts'`
- `pnpm install` may be needed if node_modules is missing (run `pnpm postinstall` after for Nuxt prepare)
### Next Priority: US-002

## Iteration 2 - 2026-01-11T00:15:00Z
### Completed: US-002 - Increase related articles count to 6
### Implementation:
- Modified `server/api/articles/[slug]/related.get.ts`: Changed limit from 5 to 6
- Grid layout in `app/pages/articles/[slug].vue` already used responsive Tailwind classes (`sm:grid-cols-2 lg:grid-cols-3`) which naturally displays 6 items as 2x3 or 3x2
### Learnings:
- The existing grid layout was already designed to be flexible - always check existing implementation before adding changes
- TypeScript check can be run with `pnpm exec tsc --noEmit` (vue-tsc may not be installed)
- Minimal changes are best - the API limit was the only code change needed
### Next Priority: US-003

## Iteration 3 - 2026-01-11T01:00:00Z
### Completed: US-003 - Persist filter state on language change
### Implementation:
- Installed `@vueuse/nuxt` and `@vueuse/core` packages
- Added `@vueuse/nuxt` to Nuxt modules in `nuxt.config.ts`
- Modified `app/pages/index.vue`:
  - Added `useLocalStorage` for language, category, tags, and dateRange filters
  - URL query params take priority over localStorage values on initial load
  - Added watchers to sync filter changes to localStorage
  - Created `clearFilters()` function that resets both reactive state and localStorage
  - Replaced inline @click handlers with `clearFilters` function calls
### Learnings:
- VueUse requires both `@vueuse/nuxt` module and `@vueuse/core` package
- `useLocalStorage` returns a ref that syncs to localStorage automatically
- When URL params exist, they should override localStorage to support shareable links
- The `filter((t): t is string => t !== null)` type guard is needed to handle nullable LocationQueryValue arrays
- Pre-existing TypeScript errors in other files don't block story completion - focus on new code
- `pnpm exec nuxi typecheck` runs Nuxt's typecheck command
### Next Priority: US-004

## Iteration 4 - 2026-01-11T02:00:00Z
### Completed: US-004 - Remove auto language detection
### Implementation:
- Modified `nuxt.config.ts`: Set `detectBrowserLanguage: false` in i18n configuration
- Previous config had `detectBrowserLanguage` object with useCookie, cookieKey, redirectOn settings
- Now disabled entirely with `false` value
### Learnings:
- @nuxtjs/i18n `detectBrowserLanguage` accepts `false` to completely disable auto-detection
- With `strategy: 'prefix_except_default'`, language preference persists via URL:
  - French (default): no prefix (e.g., `/articles/...`)
  - Other languages: prefixed (e.g., `/en/articles/...`, `/es/articles/...`)
- The language switcher in `app.vue` uses `setLocale()` which handles URL navigation
- Pre-existing TypeScript errors remain (ArticleWithDuplicates types, hub:db:schema module) but don't affect this story
### Next Priority: US-005

## Iteration 5 - 2026-01-11T03:00:00Z
### Completed: US-005 - Scroll to top on page change
### Implementation:
- Modified `app/pages/index.vue`
- Added a watcher on the `page` ref that triggers `window.scrollTo({ top: 0, behavior: 'smooth' })`
- The implementation works for all pagination interactions (next, prev, direct page clicks) since they all update the same `page` ref
### Learnings:
- `window.scrollTo` with `behavior: 'smooth'` is the simplest way to achieve smooth scrolling
- A watcher on the page ref captures all pagination changes from UPagination component
- The change is minimal (5 lines) and focused - no need to modify the pagination component itself
- Pre-existing TypeScript errors continue (ArticleWithDuplicates types, hub:db:schema module) but don't affect new code
### Next Priority: US-006

## Iteration 6 - 2026-01-11T04:00:00Z
### Completed: US-006 - Add click-to-filter on article tags
### Implementation:
- Modified `app/components/ArticleCard.vue`:
  - Added `useLocalePath` composable for i18n-aware routing
  - Added `filterByTag(tag)` function that navigates to index with tag query param
  - Added `@click.stop.prevent` handler on tag badges to call filterByTag
  - Added `cursor-pointer hover:opacity-80 transition-opacity` classes for visual feedback
- Modified `app/pages/articles/[slug].vue`:
  - Added same `useLocalePath` and `filterByTag` function
  - Added `@click` handler and hover styles on tag badges
### Learnings:
- `@click.stop.prevent` is needed on ArticleCard tags to prevent the parent card link from triggering
- `useLocalePath('/')` returns the locale-aware root path (e.g., `/en/` for English)
- `navigateTo` with query params like `{ tags: [tag] }` automatically encodes as `?tags[]=tagValue`
- On the article detail page, just `@click` is sufficient since tags aren't nested in a link
- Pre-existing TypeScript and ESLint errors (ArticleWithDuplicates types, unused getLanguageFlag) don't affect new code
### Next Priority: US-007

## Iteration 7 - 2026-01-11T05:00:00Z
### Completed: US-007 - Display source favicon on article cards
### Implementation:
- Modified `app/components/ArticleCard.vue`:
  - Added `getDomainFromUrl(url)` helper to extract hostname from sourceUrl
  - Added `getFaviconUrl(url)` helper to generate Google favicon service URL
  - Changed favicon URL from `https://favicon.is/${sourceName}` to Google's service `https://www.google.com/s2/favicons?domain=${domain}&sz=32`
  - Added `icon: 'i-lucide-globe'` as fallback when favicon is unavailable
  - Applied same fix to duplicate article favicons in UUser component
### Learnings:
- Previous implementation used `sourceName` (human-readable name like "New York Times") instead of a domain - favicon services need actual domains
- Google's favicon service (`google.com/s2/favicons?domain=...`) is more reliable than favicon.is
- The `sz=32` parameter requests 32x32 icon which scales well
- Browser handles caching automatically; Google's CDN also caches favicons
- Pre-existing TypeScript errors (ArticleWithDuplicates types, hub:db:schema module) and ESLint errors (unused getLanguageFlag) continue but don't affect new code
### Next Priority: US-008

## Iteration 8 - 2026-01-11T06:00:00Z
### Completed: US-008 - Add empty state illustrations
### Implementation:
- Created `app/assets/empty-state.svg` with Antkeeper brand illustration:
  - Magnifying glass with question marks (search metaphor)
  - Stylized ant in coral color (#f87171)
  - Decorative dots in purple, coral, and teal
- Modified `app/pages/index.vue`:
  - Enhanced empty state section with SVG illustration
  - Added proper heading and hint text styling
  - Added dark mode support with text-gray-700/300 and text-gray-500/400
  - Changed clear filters button to primary/soft variant
- Added `emptyStateHint` translations to all 4 locale files (fr, en, es, de)
### Learnings:
- The implementation was partially in place already - index.vue had a basic empty state that needed enhancement
- Brand colors from existing design: purple (#7c3aed), coral (#f87171), teal (#45bcb4)
- SVG illustrations should be placed in `app/assets/` directory
- Nuxt resolves `~/assets/` paths automatically
- Pre-existing TypeScript errors (ArticleWithDuplicates types, hub:db:schema module) and ESLint errors continue but don't affect new code
### Next Priority: US-009

## Iteration 9 - 2026-01-11T07:00:00Z
### Completed: US-009 - Add article reading time estimate
### Implementation:
- Created `app/composables/useReadingTime.ts`:
  - `calculateReadingTime(content)` - counts words and divides by 200 words/min
  - `getArticleReadingTime(summary, content)` - uses content if available, falls back to summary
  - Returns minimum 1 minute for short content
- Modified `app/components/ArticleCard.vue`:
  - Added `useReadingTime` composable import
  - Added `readingTime` computed property
  - Added reading time display in footer with clock icon (i-lucide-clock)
- Modified `app/pages/articles/[slug].vue`:
  - Added same `useReadingTime` composable and computed property
  - Added reading time display in meta info section with clock icon
- Added `readingTime` i18n key to all 4 locale files:
  - fr: "{minutes} min de lecture"
  - en: "{minutes} min read"
  - es: "{minutes} min de lectura"
  - de: "{minutes} Min. Lesezeit"
### Learnings:
- Nuxt auto-imports composables from `app/composables/` directory
- 200 words/minute is standard reading speed estimate
- `Math.ceil` ensures we always round up (better UX than underestimating)
- Using `UIcon` component with `size-4` class for consistent icon sizing
- Pre-existing TypeScript errors (ArticleWithDuplicates, hub:db:schema) and ESLint errors (unused getLanguageFlag) continue but don't affect new code
### Next Priority: US-010

## Iteration 10 - 2026-01-11T08:00:00Z
### Completed: US-010 - Add keyboard navigation for filters
### Implementation:
- Modified `app/pages/index.vue`:
  - Added `handleKeydown(event)` function that listens for Escape key
  - Added `onMounted` hook to register global keydown listener
  - Added `onUnmounted` hook to clean up the listener
  - Created `hasActiveFilters()` helper function to DRY up the filter check logic
  - Replaced duplicate filter conditions in template with `hasActiveFilters()` calls
### Learnings:
- Nuxt UI components (USelect, USelectMenu, UButton) have built-in accessibility features:
  - Tab navigation works out of the box (they're focusable HTML elements)
  - Enter key activates selections (standard select behavior)
  - Focus ring states are included via Tailwind's ring utilities
- Global keyboard shortcuts need `onMounted`/`onUnmounted` for proper cleanup
- Using a helper function for repeated boolean logic improves maintainability
- Pre-existing TypeScript errors (ArticleWithDuplicates, hub:db:schema) and ESLint errors (any type in query object) continue but don't affect new code
### Next Priority: US-011

## Iteration 11 - 2026-01-11T09:00:00Z
### Completed: US-011 - Create full-text search database indexes
### Implementation:
- Created `server/db/migrations/postgresql/0006_fulltext_search.sql`:
  - Added `search_vector` tsvector column to articles table
  - Created GIN index (`articles_search_vector_idx`) for efficient full-text search
  - Created `articles_search_vector_update()` function with weighted search vectors
  - Created trigger to auto-update search_vector on INSERT or UPDATE of title/summary/content
  - Included backfill query to populate search vectors for existing articles
- Modified `server/db/schema.ts`:
  - Added custom `tsvector` type using Drizzle's `customType` (since Drizzle lacks native support)
  - Added `searchVector` column to articles table definition
### Learnings:
- Drizzle ORM doesn't have native tsvector support - must use `customType` from `drizzle-orm/pg-core`
- PostgreSQL's `setweight()` function allows ranking: A (highest) for title, B for summary, C (lowest) for content
- Using 'simple' text search configuration for language-agnostic search (articles are in multiple languages)
- The trigger only fires on `UPDATE OF title, summary, content` to avoid unnecessary updates
- Manual SQL migrations work alongside Drizzle-generated migrations (0004, 0005 were also manual)
- Pre-existing TypeScript errors (ArticleWithDuplicates, hub:db:schema module) continue but don't affect new code
### Next Priority: US-012

## Iteration 12 - 2026-01-11T10:00:00Z
### Completed: US-012 - Create search API endpoint
### Implementation:
- Created `server/api/articles/search.get.ts`:
  - GET endpoint accepts 'q' query param for search term
  - Optional 'language' filter param to filter by language
  - Uses `ts_rank_cd()` for relevance ranking (considers proximity and frequency)
  - Pagination with page/limit/offset (default 20 per page, max 100)
  - Returns highlighted snippets using `ts_headline()` for title, summary, and content
  - Uses OR logic between search terms for flexible matching
  - Sanitizes search input to remove special characters (keeps accented letters)
### Learnings:
- PostgreSQL `ts_headline()` function generates HTML-highlighted snippets with `<mark>` tags
- `ts_rank_cd()` is better than `ts_rank()` for queries where term proximity matters
- Using 'simple' text search configuration works for multi-language content
- The tsquery string builder uses `|` (OR) for more flexible matching vs `&` (AND)
- Regex `/[^a-zA-Z0-9À-ÿ]/g` removes special chars but preserves accented letters for non-English languages
- Pre-existing TypeScript errors (ArticleWithDuplicates, hub:db:schema module) continue but don't affect new code
### Next Priority: US-013

## Iteration 13 - 2026-01-11T11:00:00Z
### Completed: US-013 - Create search input component
### Implementation:
- Created `app/components/SearchInput.vue`:
  - Desktop: Search icon button with smooth CSS transition to expand input (w-0 to w-64)
  - Mobile: Full-width layout with submit and close buttons
  - Clear button appears when text is entered
  - Enter key submits search, Escape key closes
  - Uses `useLocalePath` for i18n-aware navigation to /search page
  - Blur handler with delay to prevent accidental collapse when clicking buttons
- Modified `app/app.vue`:
  - Integrated SearchInput component in header's right slot
  - Wrapped existing controls in flex container with gap
- Added i18n translations for search keys in all 4 locales:
  - placeholder: "Search articles..." (localized)
  - open/close/submit/clear labels for accessibility
### Learnings:
- Vue Transition component with tailwind classes enables smooth expand/collapse animations
- Using `nextTick` ensures input is focused after expansion animation starts
- `useLocalePath('/search')` generates locale-aware paths (e.g., `/en/search` for English)
- The blur handler needs a small delay (150ms) to allow click events on buttons to register before collapsing
- Nuxt UI components are auto-imported - no need to import UButton, UInput, etc.
- Pre-existing TypeScript errors (ArticleWithDuplicates, hub:db:schema module) continue but don't affect new code
### Next Priority: US-014

## Iteration 14 - 2026-01-11T12:00:00Z
### Completed: US-014 - Create search results page
### Implementation:
- Created `app/pages/search.vue`:
  - Query from URL via `?q=term` parameter
  - ArticleCard grid display (responsive 1/2/3 columns)
  - Result count with localized singular/plural (search.resultCount)
  - Language filter dropdown
  - Loading state while fetching results
  - Error state for API failures
  - Empty state when no query entered (with search icon)
  - No results state with empty-state.svg illustration and helpful hint
  - Pagination with smooth scroll to top on page change
- Added SEO meta tags:
  - Dynamic title with search query
  - Description meta tag
  - Open Graph tags (ogTitle, ogDescription)
  - `noindex, follow` robots meta to prevent search result pages from being indexed
- Added i18n translations to all 4 locale files:
  - search.title: "Search Results"
  - search.resultsFor: "Results for \"{query}\""
  - search.noResultsFor: "No results for \"{query}\""
  - search.noResultsHint: "Try a different search term..."
  - search.resultCount / resultCount_plural
### Learnings:
- `useSeoMeta` can use functions for dynamic meta values that react to query changes
- `useHead` is needed separately for robots meta tag
- SearchInput component already navigates to `/search?q=term`, so page just reads the query param
- Reused existing patterns from index.vue (language filter, pagination, ArticleCard grid)
- Empty state illustrations work well for both "no results" and "no query" states
- Pre-existing TypeScript errors (ArticleWithDuplicates, hub:db:schema module) continue but don't affect new code
### Next Priority: US-015

## Iteration 15 - 2026-01-11T13:00:00Z
### Completed: US-015 - Add search autocomplete suggestions
### Implementation:
- Created `server/api/articles/suggestions.get.ts`:
  - GET endpoint accepts 'q' query param (min 2 chars)
  - Returns popular tags matching query prefix with article counts
  - Also returns matching article titles for direct navigation
  - Limits to 5-8 suggestions total
  - Tags sorted by popularity (article count), articles by recency
- Modified `app/components/SearchInput.vue`:
  - Added autocomplete dropdown below search input
  - Implemented 300ms debounce using setTimeout/clearTimeout
  - Keyboard navigation: ArrowUp/Down to select, Enter to confirm, Escape to close
  - Different icons for tags (i-lucide-tag) vs articles (i-lucide-file-text)
  - Tag suggestions show article count, article suggestions show "Article" label
  - Clicking tag searches for that tag, clicking article navigates directly
  - Works on both desktop and mobile layouts
- Added i18n translations:
  - `search.article` key in all 4 locales for article suggestion labels
### Learnings:
- Manual debounce with setTimeout/clearTimeout is simpler than installing additional deps
- `useFetch` with `immediate: false` and `watch` option fetches only when query changes
- Type casting with `as unknown as T[]` needed for raw SQL results from Drizzle
- Dropdown positioning with `absolute top-full` places it directly below input
- `role="listbox"` and `role="option"` improve accessibility for screen readers
- `@mouseenter` on options updates selectedIndex for mouse hover highlighting
- Pre-existing TypeScript errors (ArticleWithDuplicates, hub:db:schema module) continue but don't affect new code
### Next Priority: US-016

