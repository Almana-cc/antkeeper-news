# Ralph Progress Log

This file tracks learnings and progress across iterations.
Each iteration appends new entries - NEVER delete or replace existing content.

---

## Iteration 1 - 2026-01-09T10:30:00Z
### Completed: US-001 - Create GitHub Actions workflow for weekly newsletter
### Implementation:
- Created `.github/workflows/newsletter.yml`
- Scheduled for Friday 9 AM UTC (`cron: '0 9 * * 5'`)
- Added `workflow_dispatch` for manual triggering
- Setup: checkout@v4, node@v4 (Node.js 20), pnpm/action-setup@v3
- Runs `node scripts/generate-newsletter.js` (requires US-002)
- Uses peter-evans/create-pull-request@v6 to create PRs
- PR title format: "Newsletter for week of [START_DATE] to [END_DATE]"
- Environment secrets required: OPENROUTER_API_KEY, DATABASE_URL

### Learnings:
- Branch `ralph/newsletter-articles-tags` was already checked out elsewhere, used `ralph/newsletter-articles-tags-amp` instead
- Pre-existing typecheck errors in codebase (ArticleWithDuplicates type issues, hub:db:schema module) - not related to this story
- No `pnpm lint` script exists, use `pnpm eslint` instead
- Date calculation in shell: use `date -d "7 days ago"` (Linux) or `date -v-7d` (macOS) with fallback

### Next Priority: US-002

---

## Iteration 2 - 2026-01-09T11:15:00Z
### Completed: US-002 - Create standalone newsletter generation script
### Implementation:
- Created `scripts/generate-newsletter.js` (339 lines)
- Uses OpenRouter API with `mistralai/mistral-7b-instruct:free` model
- `fetchArticles()`: Calls GET /api/articles?dateRange=week&limit=50
- `selectTopArticles()`: AI selects top 3 based on scientific importance, originality, quality
- `generateNewsletterContent()`: AI generates French content with intro, summaries, key points
- `writeNewsletter()`: Writes to `newsletters/YYYY-MM-DD.md`
- Fallback strategies: Empty newsletter if no articles, uses first 3 if AI selection fails, generates basic content if AI generation fails
- Rate limit handling with exponential backoff (3 retries, 5s base delay)
- CI/CD compatible: No user interaction required, exits with code 1 on failure

### Learnings:
- Existing `openrouter-categorization.service.ts` provides good patterns for OpenRouter API calls
- Script uses CommonJS (`require`) since it runs standalone with Node.js
- Pre-existing typecheck errors are unrelated to this work (confirmed in progress.txt iteration 1)
- Verified script syntax with `node --check scripts/generate-newsletter.js`

### Next Priority: US-003

---

## Iteration 3 - 2026-01-09T12:00:00Z
### Completed: US-003 - Add newsletter history and continuity checking
### Implementation:
- Added `getPreviousNewsletterContext()` function:
  - Reads up to 4 previous newsletters from `./newsletters/*.md`
  - Extracts article titles using regex (`## \d+\.\s+(.+)`)
  - Returns `{ recentStories: [], newsletterDates: [], rawContent: [] }`
- Added `formatPreviousStoriesForPrompt()` to format context for AI prompts
- Updated `selectTopArticles(articles, previousContext)`:
  - Added criterion 6: "ÉVITER les sujets déjà traités dans les newsletters précédentes"
  - Added instruction for follow-up selection if story evolved
  - Includes previous stories list in user prompt
- Updated `generateNewsletterContent(articles, previousContext)`:
  - Adds previous context section to prompt
  - Instructs AI to reference prior editions when covering follow-up stories
- Updated `main()` to fetch and pass previous context to both functions

### Learnings:
- Newsletter title format is consistent: `## {n}. {title}` - easy to parse with regex
- No typecheck script in package.json, use `pnpm nuxt typecheck`
- Pre-existing typecheck errors still present (ArticleWithDuplicates type) - unrelated to this work
- ESLint available via `pnpm eslint <file>`

### Next Priority: US-004

